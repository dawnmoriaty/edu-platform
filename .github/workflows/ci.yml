name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '21'
  GO_VERSION: '1.25'

jobs:
  # Java CRM Build and Test
  java-crm:
    name: Java CRM Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x java-crm/gradlew
        working-directory: edu-platform
      
      - name: Build with Gradle
        run: ./gradlew build -x test
        working-directory: edu-platform/java-crm
      
      - name: Run tests
        run: ./gradlew test
        working-directory: edu-platform/java-crm
      
      - name: Build Docker image
        run: docker build -t java-crm:latest -f Dockerfile .
        working-directory: edu-platform/java-crm

  # Go Social Service Build and Test
  go-social-service:
    name: Go Social Service Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Install sqlc
        run: go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
      
      - name: Install goose
        run: go install github.com/pressly/goose/v3/cmd/goose@latest
      
      - name: Generate sqlc code
        run: sqlc generate
        working-directory: edu-platform/go-services/social-service
      
      - name: Download dependencies
        run: go mod download
        working-directory: edu-platform/go-services/social-service
      
      - name: Run tests
        run: go test ./...
        working-directory: edu-platform/go-services/social-service
      
      - name: Build
        run: go build -o bin/social-service ./main.go
        working-directory: edu-platform/go-services/social-service
      
      - name: Build Docker image
        run: docker build -t social-service:latest -f Dockerfile .
        working-directory: edu-platform/go-services/social-service

  # Kraken Gateway Build and Test
  kraken-gateway:
    name: Kraken Gateway Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Download dependencies
        run: go mod download
        working-directory: edu-platform/kraken-gateway
      
      - name: Run tests
        run: go test ./...
        working-directory: edu-platform/kraken-gateway
      
      - name: Build
        run: go build -o bin/kraken-gateway ./main.go
        working-directory: edu-platform/kraken-gateway
      
      - name: Build Docker image
        run: docker build -t kraken-gateway:latest -f Dockerfile .
        working-directory: edu-platform/kraken-gateway

  # Docker Compose Integration Test
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [java-crm, go-social-service, kraken-gateway]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        run: |
          docker-compose --version
      
      - name: Start services
        run: |
          docker-compose -f infrastructure/docker/docker-compose.dev.yml up -d
        working-directory: edu-platform
      
      - name: Wait for services
        run: |
          sleep 30
          docker-compose -f infrastructure/docker/docker-compose.dev.yml ps
        working-directory: edu-platform
      
      - name: Health checks
        run: |
          curl -f http://localhost:8080/actuator/health || exit 1
          curl -f http://localhost:8001/health || exit 1
          curl -f http://localhost:8000/health || exit 1
      
      - name: Stop services
        if: always()
        run: |
          docker-compose -f infrastructure/docker/docker-compose.dev.yml down
        working-directory: edu-platform
